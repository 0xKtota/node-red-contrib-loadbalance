<script type="text/x-red" data-help-name="Load Balance">
    <p>Load balance on outputs.  First port is admin port only.  Remaining ports are load balanced according to the selected method:</p>
    <p>
	<dl>
	<dt>Round Robin</dt><dd>Next output path and when reaches last next is first in list</dd>
	<dt>Random</dt><dd>Randomly picks next output path</dd>
	<dt>Fold on capacity</dt><dd>Uses path with capacity first in list. If all at capacity then randomly.</dd>
	<dt>Next below average capacity</dt><dd>Uses next path that is below average capacity. If all at same capacity then randomly.</dd>
	</dl>
	</p>

	<p>On no capacity</p>
	<p>
	<dl>
    <dt>Round Robin</dt><dd>See above</dd>
    <dt>Random</dt><dd>Randomly picks next output path regardless of capacity</dd> 
    <dt>Discard</dt><dd>Drops message</dd> 
    <dt>Admin port</dt><dd>Send message to admoin port 0</dd> 
	</dl>
	</p>

	<p>On no avaliability</p>
	<p>
	<dl>
    <dt>Discard</dt><dd>Drops message</dd> 
    <dt>Send admin port</dt><dd>Send message to admin port 0</dd> 
	</dl>
	</p>

	<p>
	msg.topic can be used to send directives to load balancer.  
	<dl>
	<dt>loadbalance</dt>
		<dd>Set a weigthing on a path form {path:0,capactity:100,status:1} or an array of these values.  
		All paths area initially set to {capactity:100,status:1} .  Zero is considered no capacity and for status unavailable  
		Mechanism by which receiving route can send feed back on load.
		</dd>
	</dl>
	<dt>loadbalance.debug</dt>Send medata data about routing to log<dd></dd>
	<dt>loadbalance.list</dt>Send medata data message about routing to admin port<dd></dd>
	</p>

</script>

<script type="text/x-red" data-template-name="Load Balance">

    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>
    <div class="form-row form-row-http-in-sticky">
        <label>&nbsp;</label>
        <input type="checkbox" id="node-input-sticky" style="display: inline-block; width: auto; vertical-align: top;">
        <label for="node-input-sticky" style="width: 70%;">sticky (HTTP messages using cookie)</label>
    </div>
    <div class="form-row">
        <label for="node-input-selection"><i class="fa fa-list-ul"></i> Selection Method</label>
        <select id="node-input-selection" placeholder="selection">
            <option value="next">Round Robin</option>
            <option value="random">Random</option> 
            <option value="foldweighted">Fold on capacity</option> 
            <option value="nextsmoothed">Next smoothing to average capacity</option> 
        </select>
    </div>

    <div class="form-row form-row-http-in-mps hide">
        <label>&nbsp;</label>
        <input type="checkbox" id="node-input-mps" style="display: inline-block; width: auto; vertical-align: top;">
        <label for="node-input-mps" style="width: 70%;">Messages per second capacity</label>
    </div>
    <div class="form-row form-row-http-in-defaultcapacity hide">
        <label for="node-input-defaultcapacity"><i class="icon-bookmark"></i> Default Capacity</label>
        <input type="number" id="node-input-defaultcapacity" placeholder="defaultcapacity" min=1 max=1000000 step=10>
    </div>

    <div class="form-row">
        <label for="node-input-routes"><i class="icon-bookmark"></i> Paths</label>
        <input type="number" id="node-input-routes" placeholder="Outputs" min=1 max=100>
    </div>
    <div class="form-row form-row-http-in-nocapacity hide">
        <label for="node-input-nocapacity"><i class="fa fa-list-ul"></i> At no capacity</label>
        <select id="node-input-nocapacity" placeholder="nocapacity">
            <option value="next">Round Robin</option>
            <option value="random">Random</option> 
            <option value="discard">Discard</option> 
            <option value="admin">Send admin port</option> 
        </select>
    </div>
    <div class="form-row">
        <label for="node-input-noavailablity"><i class="fa fa-list-ul"></i> At no availabilty</label>
        <select id="node-input-noavailablity" placeholder="noavailablity">
            <option value="discard">Discard</option> 
            <option value="admin">Send admin port</option> 
        </select>
    </div>

</script>

<script type="text/javascript">
    RED.nodes.registerType('Load Balance',{
    	category: 'function',
        defaults: {
            name: {value:"",required:false},
            routes: {value:1,required:true},
            outputs: {value:1,required:true},
            selection: {value:"next",required:true},
            noavailablity: {value:"admin",required:true},
            nocapacity: {value:"admin",required:true},
            defaultcapacity: {value:100,required:true},
            sticky: {value:"",required:false},
            mps: {value:"",required:false}
        },
	    inputs:1,
        inputLabels: "",
        outputs:1,
        outputLabels: ["admin"],
        icon: "icons8-multicast-80.png",
        label: function() {
            return this.name||this._("Load Balance");
        },
        labelStyle: function() {
            return "node_label_italic";
        },
        oneditprepare: function() {
        	var node=this;
        	this.outputs=1+this.routes;
        	$('#node-input-routes').change(function () {
        		node.outputs=1+Number($('#node-input-routes').val());
        	});
        	
            $("#node-input-selection").change(function() {
                if (['foldweighted','nextsmoothed'].includes( $(this).val() )) {
                    $(".form-row-http-in-defaultcapacity").show();
                    $(".form-row-http-in-nocapacity").show();
                    $(".form-row-http-in-mps").show();
                } else {
                    $(".form-row-http-in-defaultcapacity").hide();
                    $(".form-row-http-in-nocapacity").hide();
                    $(".form-row-http-in-mps").hide();
                }
            }).change();
        	
        },
        oneditsave: function() {
        },
        oneditresize: function(size) {
        }
    });
</script>